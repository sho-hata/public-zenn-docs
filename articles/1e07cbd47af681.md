---
title: "goplsのソースコードの歩き方"
emoji: "⛹️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Go, VSCode, GitHub]
published: true
---

本記事ではGoのLanguage Serverであるgoplsのソースコードを読む際に役立つであろう、プロジェクトのディレクトリ構成やアーキテクチャについて軽く紹介します。

## 　goplsとは？
goplsとは、オープンソースのGo言語のLanguage Serverです。Goで書かれています。
goplsは、VSCodeなどのエディタでGoの開発を行う際に、補完や定義ジャンプ、リファクタリングなどの機能を提供します。普段Goで開発を行っている方は、普段何気なく使っているのではないでしょうか。
goplsについては以下でも紹介しておりますので、合わせてご覧ください。

https://speakerdeck.com/shohata/gonolanguage-server-protocolshi-zhuang-gopls-nozi-dong-bu-wan-noshi-zu-miwoxue-bu

## ソースコードへのアクセス
goplsのソースコードはGitで取得することができます。

https://github.com/golang/tools


## 機能へのアクセスの仕方
goplsには「定義ジャンプ」や「補完」など、Language Serverが提供する機能が一通り実装されています。

それぞれの機能ごとに、各機能の簡単な紹介、クライアントのサポート状況、既存の問題点などがドキュメントにまとめています。
たとえばフォーマットやシンボルの変換機能を提供するtransfomationについては以下のページに記載があります。
https://github.com/golang/tools/blob/master/gopls/doc/features/transformation.md#formatting

以下のインデックスページにそれぞれの機能ごとに概要がまとめられているので、まずはここから、自分の調べたい機能について調べてみるのが良いでしょう。

https://github.com/golang/tools/blob/master/gopls/doc/features/README.md

:::message
なお、機能によってはTODOになっているものもあります（例：補完機能）。
:::

## アーキテクチャ・設計
調べたい機能についての概要がわかったら、次にその機能がどのように実装されているかを調べていきます。
ソースコードを読んでいくにあたって、まず全体像を把握しておかないとどこから読んでいけばいいのかわかりません。

以下の図は、Goのimportの依存関係に基づいたコンポーネント群の関係が示されています。

![img](https://raw.githubusercontent.com/golang/tools/8b51d6644fa2920557841cd6c6e1b21424c8a626/gopls/doc/design/architecture.svg)

最下層は、LSP（Language Server Protocol）のリクエストとレスポンスの型を定義するパッケージが配置されており、
その上の層には、RPC に関連するパッケージ（lsprpc や server）、Goの関連ファイル（golang、mod、work、template など）に関連するパッケージが配置されています。


この図は、主要コンポーネントを完全なリストではないので詳細は省かれていますが、主要機能（例：定義ジャンプ、補完、フォーマット）のコアとなる処理は、[internal/golang/](https://github.com/golang/tools/tree/master/gopls/internal/golang)に配置されています。

### 探検の始め方
#### 手っ取り早く機能のコアロジックから追っていきたい場合
このディレクトリから該当の機能と対応したファイルを探し、読み始めると良いでしょう。
ちなみに補完処理に関しては複雑な機能のため、さらにcompletionパッケージに分かれています。

#### サーバーのエントリーポイントから追っていきたい場合
goplsはLauguage Server、つまりサーバーなので、クライアントからのリクエストを受け取り、それに対してレスポンスを返すという基本的な機能を持っています。普段、Web APIを開発している方は、Serverパッケージから読み始めると理解しやすいかもしれません。
https://github.com/golang/tools/blob/master/gopls/internal/protocol/tsserver.go#L168 あたりにリクエストハンドラが実装されているので、調べたい機能のケースから追っていくと追いやすいです。


### 探検道具
#### 設計ドキュメント
各機能ごとではなく、全体の設計について知りたい場合は以下のドキュメントが参考になります。goplsが目標としていること、逆に目標としていないこと、アーキテクチャ決定などが記載されています。
また、goplsはコミュニティ開発者作のツール群を統合したものであるため、統合前のツールへアクセスできるリンクも記載されています。
https://github.com/golang/tools/blob/master/gopls/doc/design/design.md

#### Github Copilot Chat
goplsのコードリーディングでは、VSCode限定になってしまいますが、Github Copilot CHatがおすすめです。goplsの全体やファイルのコンテキストを読み取って質問しながら進めることで、格段に効率的にコードリーディングができます。

## まとめ
本記事ではgoplsのソースコードを読む際に役立つであろう、プロジェクトのパッケージ構成やアーキテクチャについて軽く紹介しました。goplsについての解説記事はまだまだ少ないので、この記事がgoplsのソースコードを読みとくきっかけになれば幸いです。
