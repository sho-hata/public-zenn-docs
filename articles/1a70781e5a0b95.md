---
title: "Goã®nil panicã‚’é˜²ãé™çš„è§£æãƒ„ãƒ¼ãƒ«ï¼šNilAray"
emoji: "ğŸ¤¯"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [go,é™çš„è§£æ]
published: true
---

## NilAway
https://github.com/uber-go/nilaway
## ã©ã‚“ãªã‚‚ã®ï¼Ÿ
- nil ãƒ‘ãƒ‹ãƒƒã‚¯ã«ã‚ˆã‚‹ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ç®‡æ‰€ã‚’æŒ‡æ‘˜ã—ã¦ãã‚Œã‚‹é™çš„è§£æãƒ„ãƒ¼ãƒ«
- ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ã§å‹•ãã€‚golangci-lintã§ä½¿ç”¨ã™ã‚‹ã«ã¯ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒå¿…è¦ã€‚

## å…ˆè¡ŒæŠ€è¡“ã‚„ãƒ„ãƒ¼ãƒ«ã¨æ¯”ã¹ã¦ã©ã“ãŒã™ã”ã„ï¼Ÿ
- æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«åŒæ¢±ã•ã‚Œã¦ã„ã‚‹nilness[^1]ã§ã¯ãƒã‚§ãƒƒã‚¯ã§ããªã„nil ãƒ‘ãƒ‹ãƒƒã‚¯ã¨ãªã‚Šã†ã‚‹ç®‡æ‰€ã‚’æŒ‡æ‘˜ã™ã‚‹
    - é–¢æ•°ã‚„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å¢ƒç•Œã‚’è·¨ã„ã§nilãƒ•ãƒ­ãƒ¼ã‚’è¿½è·¡
    - nil ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å€¤ã‚’å ±å‘Š

ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€nilnessã¯ã‚¨ãƒ©ãƒ¼ã‚’å ±å‘Šã—ã¦ãã‚Œãªã„ãŒã€NilAwayã¯nilãƒ‘ãƒ‹ãƒƒã‚¯ã‚’å ±å‘Šã—ã¦ãã‚Œã‚‹ã€‚
```go
var p *P
if someCondition {
      p = &P{}
}
print(p.f) // nilness reports NO error here, but NilAway does.
```

## æŠ€è¡“ã®ã‚­ãƒ¢ã¯ã©ã“ï¼Ÿ
> Our main idea is that nilability flows in code can be modeled as a system of global typing constraints, which can then be solved using a 2-SAT algorithm to determine potential contradictions
Core Idea of NilAway[^2]

ã‚³ãƒ¼ãƒ‰å†…ã®nilå¯èƒ½æ€§ãƒ•ãƒ­ãƒ¼ã‚’å‹ä»˜ã‘åˆ¶ç´„ã®ã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦ãƒ¢ãƒ‡ãƒ«åŒ–ã—ã€2-SATã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§`nilable constraint`ã‹ã‚‰`nonnil constaint`ã«nil å€¤ãŒæµã‚Œã¦ã„ã‚‹ç®‡æ‰€ã‚’å‰²ã‚Šå‡ºã—ã¦ã„ã‚‹ã¨ã“ã‚ã€‚

### ã©ã†ã„ã†ã“ã¨ï¼Ÿ
2-SATã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ [^3]
- ã„ãã¤ã‹ã®å¤‰æ•°ã¨ãã‚Œã‚‰ã®å¤‰æ•°ã«å¯¾ã™ã‚‹ã€ŒAãªã‚‰ã°Bã€ã¨ã„ã£ãŸåˆ¶ç´„æ¡ä»¶ãŒä¸ãˆã‚‰ã‚ŒãŸã¨ãã«ã€å…¨ã¦ã®åˆ¶ç´„æ¡ä»¶ã‚’æº€ãŸã™ã‚ˆã†ãªå¤‰æ•°ã®å€¤ã®çµ„ã¿åˆã‚ã›ï¼ˆçœŸå½ï¼‰ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹ã€‚
- ä¾‹ï¼šã€Œé›¨ãŒé™ã£ãŸã‚‰å‚˜ã‚’ã•ã™ã€ã¨ã„ã†åˆ¶ç´„æ¡ä»¶ã¯ã€å¤‰æ•°ã€Œé›¨ã€ã¨ã€Œå‚˜ã€ãŒã€ã€Œé›¨ãŒçœŸãªã‚‰ã°å‚˜ã‚‚çœŸã€ã¨ã„ã†é–¢ä¿‚ã«ãªã£ã¦ã„ã‚‹ã¨è€ƒãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚2-SATå•é¡Œã§ã¯ã€ã“ã®ã‚ˆã†ãªåˆ¶ç´„æ¡ä»¶ãŒãŸãã•ã‚“ä¸ãˆã‚‰ã‚Œã€ãã‚Œã‚‰ã‚’ã™ã¹ã¦æº€ãŸã›ã‚‹ã‹ã‚’åˆ¤å®šã™ã‚‹ã€‚
- nilAwayã§ã¯ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä¸­ã®nilå€¤ã®ãƒ•ãƒ­ãƒ¼ï¼ˆnilå€¤ãŒã©ã“ã‹ã‚‰æ¥ã¦ã©ã“ã¸è¡Œãã®ã‹ï¼‰ã‚’ã€ã“ã®2-SATå•é¡Œã¨ã—ã¦ãƒ¢ãƒ‡ãƒ«åŒ–ã—ã€`nilable constraint`ã‹ã‚‰`nonnil constaint`ã«nilå€¤ãŒæµã‚Œã¦ã„ã‚‹ç®‡æ‰€ï¼ˆçŸ›ç›¾ï¼‰ã‚’è¦‹ã¤ã‘ã¦ã„ã‚‹ã€‚

nilable constraint(ä»¥é™ã€nilable åˆ¶ç´„ï¼‰
- å¤‰æ•°ã‚„å€¤ãŒnilã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã¨ã„ã†ã“ã¨ã‚’è¡¨ã™åˆ¶ç´„
- ä»¥ä¸‹ã‚³ãƒ¼ãƒ‰ã§ã¯ã€é–¢æ•°fooã¯stringå‹ã®ãƒã‚¤ãƒ³ã‚¿ã‚’è¿”ã—ã¦ã„ã‚‹ãŒã€å¤‰æ•°xã¯åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ã€‚ãã®ãŸã‚ã€xã¯nilã§ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€`return x`ã¯nilable åˆ¶ç´„ã¨ãªã‚‹ã€‚
```go
func foo() *string {
  var x *string
  return x
}
```

nonnil constraintï¼ˆä»¥é™ã€non nilåˆ¶ç´„ï¼‰
- å¤‰æ•°ã‚„å€¤ãŒnilã§ã¯ãªã„ã¨ã„ã†ã“ã¨ã‚’è¡¨ã™åˆ¶ç´„
```go
func bar(x *string) {
  fmt.Println(*x)
}
```
ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€é–¢æ•°barã¯stringå‹ã®ãƒã‚¤ãƒ³ã‚¿ã‚’å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚Šã€ãã®ãƒã‚¤ãƒ³ã‚¿ãŒæŒ‡ã™å€¤ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã€‚ã“ã“ã§ã€ãƒã‚¤ãƒ³ã‚¿xãŒnilã®å ´åˆã€`*x`ã«ã‚ˆã‚‹å‚ç…§ã¯nil ãƒ‘ãƒ‹ãƒƒã‚¯ã‚’å¼•ãèµ·ã“ã™ãŸã‚ã€`*x`ã¯non nilåˆ¶ç´„ã¨ãªã‚‹ã€‚

### å…·ä½“ä¾‹
ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨nil ãƒ‘ãƒ‹ãƒƒã‚¯ã«ãªã‚‹ã€‚`obj`ã¯nilã«ãªã‚‹ã«ã‚‚é–¢ã‚ã‚‰ãšã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºãã†ã¨ã—ã¦ã„ã‚‹ãŸã‚ã€‚
```go
type MyInterface interface {
	Method() int
}

func MyFunc() MyInterface {
	return nil
}

func main() {
	obj := MyFunc()
	result := obj.Method() // panic: runtime error: invalid memory address or nil pointer dereference
	fmt.Println(result)
}
```

ã–ã£ãã‚Šã€ç­†è€…ãŒç†è§£ã—ãŸç¯„å›²ã§å‡¦ç†ã®æµã‚Œã‚’è¿½ã£ã¦ã¿ã‚‹ã€‚
1. `nilable constraint`ã¨`nonnil constraint`ã®åé›†
    1.   MyFunc() é–¢æ•°ã®æˆ»ã‚Šå€¤ãŒ MyInterface å‹ã® nilã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å€¤ã‚’è¿”ã—ã¦ã„ã‚‹ãŸã‚ã€nilable åˆ¶ç´„ã¨ã—ã¦ãƒãƒ¼ã‚¯ã€‚
    1. main() é–¢æ•°å†…ã® obj.Method() ã®å‘¼ã³å‡ºã—ã¯ã€obj ãŒnon nilåˆ¶ç´„ã§ã‚ã‚‹ã“ã¨ã‚’ãƒãƒ¼ã‚¯ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã«ã¯ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå…·ä½“çš„ãªå‹ã®å®Ÿè£…ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’ä¿æŒã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€‚
2. å«æ„ã‚°ãƒ©ãƒ•ã®æ§‹ç¯‰
    1.  åé›†ã—ãŸåˆ¶ç´„ã«åŸºã¥ã„ã¦ã€æ¬¡ã®ã‚ˆã†ãªå«æ„ã‚°ãƒ©ãƒ•[^4]ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚
        1. ãƒãƒ¼ãƒ‰: MyFunc() ã®æˆ»ã‚Šå€¤, obj
        1. ã‚¨ãƒƒã‚¸: MyFunc() ã®æˆ»ã‚Šå€¤ -> obj

3. å«æ„ã‚°ãƒ©ãƒ•ã®èµ°æŸ»:
    1. nilAway ã¯ã€MyFunc() ã®æˆ»ã‚Šå€¤ãŒ nil ã§ã‚ã‚‹ã¨ã„ã†æƒ…å ±ã‹ã‚‰å§‹ã‚ã€å«æ„ã‚°ãƒ©ãƒ•ã®ã‚¨ãƒƒã‚¸ã‚’ä»‹ã—ã¦ obj ã«ä¼æ’­ã™ã‚‹ã€‚ãã®çµæœã€obj ã‚‚ nil ã§ã‚ã‚‹ã¨æ¨è«–ã•ã‚Œã‚‹ã€‚
4. çŸ›ç›¾ã®æ¤œå‡º
    1. nilAway ã¯ã€obj ã«å¯¾ã—ã¦ nil å¯èƒ½ã¨non nil ã®ä¸¡æ–¹ã®åˆ¶ç´„ãŒã‚ã‚‹ã“ã¨ã‚’æ¤œå‡ºã™ã‚‹ã€‚obj ãŒ nil ã®å ´åˆã« obj.Method() ã‚’å‘¼ã³å‡ºã™ã¨ nil ãƒ‘ãƒ‹ãƒƒã‚¯ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã€ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦å ±å‘Šã™ã‚‹ã€‚


## æ¬¡ã«èª­ã‚€ã¹ãæƒ…å ±ã¯ï¼Ÿ
Uber Blog -engineering
- https://www.uber.com/en-JP/blog/nilaway-practical-nil-panic-detection-for-go

NilArayã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- https://github.com/uber-go/nilaway/wiki

## ãŠã‚ã‚Šã«
æ³¨æ„ç‚¹ã§ã™ãŒã€å…¬å¼ãƒªãƒã‚¸ãƒˆãƒªã§è¨€åŠã•ã‚Œã¦ã„ã‚‹é€šã‚Šã€NilAway ã¯ç¾åœ¨é–‹ç™ºä¸­ã¨ã„ã†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ã™ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå……å®Ÿã—ã¦ã„ãªã„ãƒ»ä¸€éƒ¨æ¬ ã‘ã¦ã„ã‚‹ãªã©æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

ã¨ã¯ã„ãˆã€æ°—ã¥ãã«ãã„nilãƒ‘ãƒ‹ãƒƒã‚¯ã‚’å ±å‘Šã—ã¦ãã‚Œã‚‹å®Ÿç”¨çš„ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚çš†ã•ã‚“ã‚‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«çµ„ã¿è¾¼ã‚“ã§è©¦ã—ã¦ã¿ã¦ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€‚



[^1]: https://pkg.go.dev/golang.org/x/tools/go/analysis/passes/nilness
[^2]: https://www.uber.com/en-JP/blog/nilaway-practical-nil-panic-detection-for-go/#:~:text=Our%20main%20idea%20is%20that%20nilability%20flows%20in%20code%20can%20be%20modeled%20as%20a%20system%20of%20global%20typing%20constraints%2C%20which%20can%20then%20be%20solved%20using%20a%202-SAT%20algorithm%20to%20determine%20potential%20contradictions
[^3]: https://en.wikipedia.org/wiki/2-satisfiability?uclick_id=3a0e8c6c-f4fe-4f94-9448-eb11df90bde1
[^4]: https://en.wikipedia.org/wiki/Implication_graph
